<!-- Header -->
<div class="dashboard-header">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center py-3">
      <div>
        <h2 class="mb-0">Bună, {{ prenume }} {{ nume }}!</h2>
        <small class="text-muted">Panou de administrare</small>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" [routerLink]="'/user/' + id">
          <i class="bi bi-person-gear"></i> Profil
        </button>
        <button class="btn btn-outline-success position-relative" routerLink="/mesagerie">
          <i class="bi bi-chat-dots"></i> Mesagerie
          <span *ngIf="mesajeNecitite > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ mesajeNecitite }}
            <span class="visually-hidden">mesaje necitite</span>
          </span>
        </button>
        <button (click)="logout()" class="btn btn-danger">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Coloana stângă - Upload și Imagini -->
    <div class="col-lg-8">
      <!-- Upload Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-upload"></i> Încărcare Imagine Medicală</h5>
        </div>
        <div class="card-body">
          <!-- File Selection -->
          <div class="mb-3">
            <label class="form-label fw-bold">Selectare Imagine</label>
            <input type="file" (change)="onFileSelected($event)" class="form-control" accept="image/*" />
          </div>

          <!-- Image Preview -->
          <div class="mb-3" *ngIf="imagePreviewUrl">
            <label class="form-label fw-bold">
              <i class="bi bi-eye"></i> Previzualizare Imagine
            </label>
            <div class="image-preview-container">
              <img [src]="imagePreviewUrl" alt="Preview" class="image-preview">
              <div class="preview-info">
                <small class="text-muted">
                  <i class="bi bi-file-image"></i> {{ selectedFile?.name }}
                  <span *ngIf="selectedFile"> - {{ (selectedFile.size / 1024).toFixed(2) }} KB</span>
                </small>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="mb-3 d-flex gap-2">
            <button (click)="analyzeTumor()" class="btn btn-warning" [disabled]="!selectedFile || isAnalyzing">
              <i class="bi bi-clipboard-pulse"></i> Analizează Tumoare
            </button>
            <button (click)="uploadImage()" class="btn btn-success" [disabled]="!selectedFile">
              <i class="bi bi-cloud-upload"></i> Încarcă cu Imagine
            </button>
            <button (click)="createPacientWithoutImage()" class="btn btn-primary">
              <i class="bi bi-person-plus"></i> Creează Pacient
            </button>
          </div>

          <div class="alert alert-info mb-3">
            <small>
              <i class="bi bi-info-circle"></i> 
              <strong>Notă:</strong> Poți crea un pacient fără imagine medicală folosind butonul "Creează Pacient". 
              Imaginile pot fi adăugate mai târziu din pagina pacientului.
            </small>
          </div>

          <!-- Patient Info Form -->
          <div class="patient-form">
            <h6 class="mb-3 text-primary"><i class="bi bi-person-badge"></i> Informații Pacient</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nume</label>
                <input type="text" [(ngModel)]="numePacient" placeholder="Introduceți numele" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Prenume</label>
                <input type="text" [(ngModel)]="prenumePacient" placeholder="Introduceți prenumele" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">CNP</label>
                <input type="text" [(ngModel)]="cnp" placeholder="Introduceți CNP" class="form-control" maxlength="13" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Data Nașterii</label>
                <input type="date" [(ngModel)]="dataNasterii" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Sex</label>
                <select [(ngModel)]="sex" class="form-control">
                  <option value="" disabled selected>Selectează categoria</option>
                  <option value="FEMININ">Feminin</option>
                  <option value="MASCULIN">Masculin</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Număr Telefon</label>
                <input type="text" [(ngModel)]="numarTelefon" placeholder="07xxxxxxxx" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Detalii</label>
                <textarea [(ngModel)]="detalii" placeholder="Detalii suplimentare..." class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Istoric Medical</label>
                <textarea [(ngModel)]="istoricMedical" placeholder="Istoric medical pacient..." class="form-control" rows="2"></textarea>
              </div>
            </div>
          </div>

          <!-- Prediction Result -->
          <div class="mt-3" *ngIf="predictionResult">
            <div class="alert" 
                 [ngClass]="{'alert-danger': predictionResult.includes('detectată'), 
                             'alert-success': predictionResult.includes('Nu s-a detectat'),
                             'alert-info': isAnalyzing,
                             'alert-warning': predictionResult.includes('disponibil') || predictionResult.includes('Eroare')}">
              <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div class="flex-grow-1">
                  <strong>{{ predictionResult }}</strong>
                  <span *ngIf="predictionConfidence > 0"> 
                    - Încredere: {{ (predictionConfidence * 100).toFixed(2) }}%
                  </span>
                </div>
                <div *ngIf="isAnalyzing" class="spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">Se analizează...</span>
                </div>
              </div>
              <small *ngIf="predictionResult.includes('disponibil')" class="d-block mt-2">
                <em>Notă: Imaginea a fost încărcată cu succes. Serviciul ML poate fi activat ulterior.</em>
              </small>
            </div>
          </div>

          <!-- Status Message -->
          <div *ngIf="message" class="alert alert-info mt-3">
            <i class="bi bi-check-circle"></i> {{ message }}
          </div>
        </div>
      </div>

      <!-- Patients Gallery -->
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-people"></i> Pacienții tăi</h5>
          <span class="badge bg-light text-dark">{{ filteredPacienti.length }} / {{ pacienti.length }}</span>
        </div>
        <div class="card-body">
          <!-- Bară de căutare -->
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" 
                     [(ngModel)]="searchTerm" 
                     (input)="searchPacienti()" 
                     class="form-control" 
                     placeholder="Caută după numele pacientului sau CNP...">
              <button class="btn btn-outline-secondary" 
                      type="button" 
                      (click)="clearSearch()" 
                      *ngIf="searchTerm">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <!-- Lista de pacienți filtrați -->
          <div class="images-gallery">
            <div *ngFor="let pacient of filteredPacienti; let i = index" class="patient-card" 
                 (click)="viewPacient(pacient)">
              <div class="image-wrapper">
                <!-- Afișare DICOM placeholder -->
                <div *ngIf="pacient.imagini && pacient.imagini.length > 0 && pacient.imagini[0].isDicom" 
                     class="patient-image dicom-thumbnail-dashboard">
                  <i class="bi bi-file-earmark-medical"></i>
                  <small>DICOM</small>
                </div>
                <!-- Afișare imagine normală -->
                <img *ngIf="pacient.imagini && pacient.imagini.length > 0 && !pacient.imagini[0].isDicom" 
                     [src]="pacient.imagini[0].imageUrl" 
                     [alt]="'Prima imagine a pacientului ' + pacient.numePacient" 
                     class="patient-image" />
                <!-- Placeholder fără imagini -->
                <div *ngIf="!pacient.imagini || pacient.imagini.length === 0" 
                     class="patient-image no-image">
                  <i class="bi bi-person"></i>
                </div>
              </div>
              <div class="patient-info">
                <div class="patient-name">
                  <strong>{{ pacient.numePacient }} {{ pacient.prenumePacient }}</strong>
                </div>
                <div class="patient-details">
                  <small class="text-muted" *ngIf="pacient.cnp">CNP: {{ pacient.cnp }}</small>
                  <small class="text-muted d-block">
                    <i class="bi bi-images"></i> {{ pacient.imagini.length || 0 }} 
                    {{ (pacient.imagini.length || 0) === 1 ? 'imagine' : 'imagini' }}
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Mesaj când nu sunt rezultate -->
          <div *ngIf="filteredPacienti.length === 0 && pacienti.length > 0" class="alert alert-info">
            <i class="bi bi-info-circle"></i> Nu s-au găsit pacienți pentru căutarea "{{ searchTerm }}"
          </div>

          <!-- Mesaj când nu sunt pacienți deloc -->
          <div *ngIf="pacienti.length === 0" class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Nu aveți pacienți încărcați încă.
          </div>
        </div>
      </div>
    </div>

    <!-- Coloana dreaptă - Calendar -->
    <div class="col-lg-4">
      <div class="card shadow-sm sticky-top" style="top: 20px;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Calendar Programări</h5>
        </div>
        <div class="card-body">
          <!-- Calendar -->
          <div class="calendar-container">
            <div class="calendar-header">
              <button class="btn btn-sm btn-outline-secondary" (click)="previousMonth()">
                <i class="bi bi-chevron-left"></i>
              </button>
              <h6 class="mb-0">{{ currentMonthName }} {{ currentYear }}</h6>
              <button class="btn btn-sm btn-outline-secondary" (click)="nextMonth()">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
            
            <div class="calendar-grid">
              <!-- Zilele săptămânii -->
              <div class="calendar-weekdays">
                <div class="weekday">Lu</div>
                <div class="weekday">Ma</div>
                <div class="weekday">Mi</div>
                <div class="weekday">Jo</div>
                <div class="weekday">Vi</div>
                <div class="weekday">Sâ</div>
                <div class="weekday">Du</div>
              </div>
              
              <!-- Zilele lunii -->
              <div class="calendar-days">
                <div *ngFor="let day of calendarDays" 
                     class="calendar-day" 
                     [class.other-month]="day.otherMonth"
                     [class.today]="day.isToday"
                     [class.selected]="day.selected"
                     [class.has-appointment]="day.hasAppointment"
                     (click)="selectDay(day)">
                  {{ day.day }}
                  <span *ngIf="day.hasAppointment" class="appointment-dot"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Programări viitoare -->
          <div class="mt-4">
            <h6 class="text-muted mb-3"><i class="bi bi-clock-history"></i> Programări Viitoare</h6>
            <div class="upcoming-appointments">
              <div *ngIf="programariViitoare.length === 0" class="alert alert-info text-center">
                <small><i class="bi bi-info-circle"></i> Nu există programări viitoare</small>
              </div>
              
              <div *ngFor="let programare of programariViitoare" class="appointment-item">
                <div class="appointment-date">
                  <strong>{{ formatProgramareDate(programare.dataProgramare) }}</strong>
                  <small>{{ formatProgramareTime(programare.dataProgramare) }}</small>
                </div>
                <div class="appointment-details">
                  <strong>{{ programare.pacientNume }} {{ programare.pacientPrenume }}</strong>
                  <small>{{ programare.tipConsultatie || 'Consultație' }}</small>
                  <small class="text-muted d-block">
                    <i class="bi bi-clock"></i> {{ formatProgramareInterval(programare.dataProgramare, programare.durataMinute || 30) }}
                  </small>
                </div>
                <button *ngIf="!isProgramareInPast(programare)" class="btn btn-sm btn-outline-danger" (click)="deleteProgramare(programare.id!)" title="Șterge programarea">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Statistici rapide -->
          <div class="mt-4">
            <h6 class="text-muted mb-3"><i class="bi bi-graph-up"></i> Statistici</h6>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number">{{ imagini.length }}</div>
                <div class="stat-label">Total Imagini</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">{{ programariViitoare.length }}</div>
                <div class="stat-label">Programări</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Meniul contextual -->
<ul *ngIf="contextMenuVisible" 
    [ngStyle]="{'top.px': menuY, 'left.px': menuX}" 
    class="context-menu list-group position-fixed p-2 bg-white border rounded shadow">
  <!-- <li (click)="deleteImage()" class="list-group-item list-group-item-action">Șterge</li> -->
</ul>

<!-- Modal pentru creare programare -->
<div *ngIf="showProgramareModal" class="modal-overlay" (click)="closeProgramareModal()">
  <div class="modal-content-programare" (click)="$event.stopPropagation()">
    <div class="modal-header-programare">
      <h5><i class="bi bi-calendar-plus"></i> Adaugă Programare</h5>
      <button class="btn-close" (click)="closeProgramareModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <div class="modal-body-programare">
      <div class="alert alert-info mb-3">
        <i class="bi bi-calendar-check"></i> 
        Data selectată: <strong>{{ formatSelectedDate() }}</strong>
      </div>

      <form>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nume Pacient *</label>
            <div class="autocomplete-wrapper">
              <input type="text" 
                     [(ngModel)]="programareNume" 
                     name="programareNume" 
                     (input)="onProgramareNumeChange()"
                     (focus)="onProgramareNumeChange()"
                     (blur)="hideSuggestions()"
                     class="form-control" 
                     placeholder="Introduceți numele" 
                     required 
                     autocomplete="off" />
              
              <div *ngIf="showPacientiSuggestions" class="autocomplete-suggestions">
                <div *ngFor="let pacient of pacientiFiltrati" 
                     class="suggestion-item"
                     (click)="selectPacient(pacient)">
                  <div class="suggestion-name">
                    <strong>{{ pacient.numePacient }} {{ pacient.prenumePacient }}</strong>
                  </div>
                  <div class="suggestion-details" *ngIf="pacient.cnp">
                    <small>CNP: {{ pacient.cnp }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Prenume Pacient *</label>
            <input type="text" [(ngModel)]="programarePrenume" name="programarePrenume" 
                   class="form-control" placeholder="Introduceți prenumele" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">CNP</label>
            <input type="text" [(ngModel)]="programareCnp" name="programareCnp" 
                   class="form-control" placeholder="CNP pacient" maxlength="13" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Ora *</label>
            <input type="time" [(ngModel)]="programareOra" name="programareOra" 
                   class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Tip Consultație</label>
            <select [(ngModel)]="programareTip" name="programareTip" class="form-control">
              <option value="">Selectează tipul</option>
              <option value="Consultație generală">Consultație generală</option>
              <option value="Control">Control</option>
              <option value="Investigație">Investigație</option>
              <option value="Intervenție">Intervenție</option>
              <option value="Altele">Altele</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Durată (minute)</label>
            <input type="number" [(ngModel)]="programareDurata" name="programareDurata" 
                   class="form-control" min="15" step="15" />
          </div>
          <div class="col-12">
            <label class="form-label">Detalii</label>
            <textarea [(ngModel)]="programareDetalii" name="programareDetalii" 
                      class="form-control" rows="3" 
                      placeholder="Detalii despre programare..."></textarea>
          </div>
        </div>
      </form>
    </div>
    
    <div class="modal-footer-programare">
      <button class="btn btn-secondary" (click)="closeProgramareModal()">
        <i class="bi bi-x-circle"></i> Anulează
      </button>
      <button class="btn btn-primary" (click)="createProgramare()">
        <i class="bi bi-check-circle"></i> Salvează Programarea
      </button>
    </div>
  </div>
</div>

<!-- Modal pentru vizualizare programări zi selectată -->
<div *ngIf="showProgramariZiModal" class="modal-overlay" (click)="closeProgramariZiModal()">
  <div class="modal-content-programare" (click)="$event.stopPropagation()">
    <div class="modal-header-programare">
      <h5><i class="bi bi-calendar-day"></i> Programări {{ formatSelectedDate() }}</h5>
      <button class="btn-close" (click)="closeProgramariZiModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <div class="modal-body-programare">
      <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle"></i> 
        <strong>{{ programariZiSelectata.length }}</strong> programare/programări găsite
      </div>

      <div class="programari-zi-list">
        <div *ngFor="let prog of programariZiSelectata" class="programare-card">
          <div class="programare-header">
            <div class="programare-time">
              <i class="bi bi-clock"></i>
              <strong>{{ formatProgramareInterval(prog.dataProgramare, prog.durataMinute || 30) }}</strong>
            </div>
            <button *ngIf="!isProgramareInPast(prog)" 
                    class="btn btn-sm btn-outline-danger" 
                    (click)="deleteProgramare(prog.id!)"
                    title="Șterge programarea">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="programare-body">
            <div class="programare-info">
              <i class="bi bi-person"></i>
              <strong>{{ prog.pacientNume }} {{ prog.pacientPrenume }}</strong>
            </div>
            <div class="programare-info" *ngIf="prog.pacientCnp">
              <i class="bi bi-card-text"></i>
              <span>CNP: {{ prog.pacientCnp }}</span>
            </div>
            <div class="programare-info" *ngIf="prog.tipConsultatie">
              <i class="bi bi-clipboard-pulse"></i>
              <span>{{ prog.tipConsultatie }}</span>
            </div>
            <div class="programare-info" *ngIf="prog.detalii">
              <i class="bi bi-journal-text"></i>
              <small class="text-muted">{{ prog.detalii }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer-programare">
      <button class="btn btn-secondary" (click)="closeProgramariZiModal()">
        <i class="bi bi-x-circle"></i> Închide
      </button>
      <button *ngIf="!isSelectedDateInPast()" class="btn btn-success" (click)="openCreateProgramareModal()">
        <i class="bi bi-plus-circle"></i> Adaugă Programare
      </button>
    </div>
  </div>
</div>

<!-- Modal pentru confirmare ștergere programare -->
<div *ngIf="showDeleteConfirmModal" class="modal-overlay" (click)="cancelDeleteProgramare()">
  <div class="modal-content-confirm" (click)="$event.stopPropagation()">
    <div class="modal-header-confirm">
      <i class="bi bi-exclamation-triangle-fill text-warning"></i>
      <h5>Confirmare Ștergere</h5>
    </div>
    
    <div class="modal-body-confirm">
      <p>Sigur dorești să ștergi această programare?</p>
      <p class="text-muted mb-0"><small>Această acțiune nu poate fi anulată.</small></p>
    </div>
    
    <div class="modal-footer-confirm">
      <button class="btn btn-secondary" (click)="cancelDeleteProgramare()">
        <i class="bi bi-x-circle"></i> Anulează
      </button>
      <button class="btn btn-danger" (click)="confirmDeleteProgramare()">
        <i class="bi bi-trash"></i> Șterge
      </button>
    </div>
  </div>
</div>

<!-- Notificări personalizate -->
<div *ngIf="showNotification" class="notification-overlay">
  <div class="notification-toast" 
       [ngClass]="{
         'notification-success': notificationType === 'success',
         'notification-error': notificationType === 'error',
         'notification-warning': notificationType === 'warning'
       }">
    <div class="notification-icon">
      <i *ngIf="notificationType === 'success'" class="bi bi-check-circle-fill"></i>
      <i *ngIf="notificationType === 'error'" class="bi bi-x-circle-fill"></i>
      <i *ngIf="notificationType === 'warning'" class="bi bi-exclamation-triangle-fill"></i>
    </div>
    <div class="notification-content">
      <p class="notification-message">{{ notificationMessage }}</p>
    </div>
    <button class="notification-close" (click)="closeNotification()">
      <i class="bi bi-x"></i>
    </button>
  </div>
</div>
