<div class="mesagerie-container">
  <!-- Header -->
  <div class="mesagerie-header">
    <button class="btn-back" (click)="goBack()">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h2><i class="bi bi-chat-dots"></i> Mesagerie</h2>
    <div class="header-info">
      <span class="user-name">{{ currentUserName }}</span>
      <span class="badge-notification" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
    </div>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <div class="search-container">
      <i class="bi bi-search search-icon"></i>
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        (input)="searchUsers()" 
        class="search-input" 
        placeholder="Caută utilizatori după nume sau email..."
        autocomplete="off" />
      <button 
        *ngIf="searchTerm" 
        class="clear-btn" 
        (click)="clearSearch()">
        <i class="bi bi-x-circle-fill"></i>
      </button>
    </div>
  </div>

  <!-- Users List -->
  <div class="users-list">
    <!-- Utilizatori cu mesaje -->
    <div *ngIf="usersWithMessages.length > 0 && !searchTerm" class="section-header">
      <i class="bi bi-chat-dots-fill"></i>
      <span>Conversații Recente ({{ usersWithMessages.length }})</span>
    </div>

    <div class="user-cards" *ngIf="usersWithMessages.length > 0 && !searchTerm">
      <div 
        *ngFor="let user of usersWithMessages" 
        class="user-card" 
        [class.has-unread]="user.unreadMessagesCount > 0"
        (click)="selectUser(user)">
        <div class="user-avatar">
          <img [src]="getUserProfilePhoto(user)" 
               [alt]="user.prenume + ' ' + user.nume"
               (error)="onImageError($event)"
               class="avatar-img">
          <i class="bi bi-person-circle"></i>
          <span class="unread-badge" *ngIf="user.unreadMessagesCount > 0">{{ user.unreadMessagesCount }}</span>
        </div>
        <div class="user-info">
          <div class="user-name-email">
            <h4>{{ user.prenume }} {{ user.nume }}</h4>
            <p class="user-email">{{ user.email }}</p>
          </div>
          <div class="user-details" *ngIf="user.telefon || user.specialitate">
            <span *ngIf="user.telefon" class="detail-item">
              <i class="bi bi-telephone"></i> {{ user.telefon }}
            </span>
            <span *ngIf="user.specialitate" class="detail-item">
              <i class="bi bi-briefcase"></i> {{ user.specialitate }}
            </span>
          </div>
        </div>
        <div class="user-action">
          <i class="bi bi-chat-left-text"></i>
        </div>
      </div>
    </div>

    <!-- Alți utilizatori -->
    <div *ngIf="otherUsers.length > 0 && !searchTerm" class="section-header">
      <i class="bi bi-people"></i>
      <span>Toți Utilizatorii ({{ otherUsers.length }})</span>
    </div>

    <div class="user-cards" *ngIf="otherUsers.length > 0 && !searchTerm">
      <div 
        *ngFor="let user of otherUsers" 
        class="user-card" 
        (click)="selectUser(user)">
        <div class="user-avatar">
          <img [src]="getUserProfilePhoto(user)" 
               [alt]="user.prenume + ' ' + user.nume"
               (error)="onImageError($event)"
               class="avatar-img">
          <i class="bi bi-person-circle"></i>
        </div>
        <div class="user-info">
          <div class="user-name-email">
            <h4>{{ user.prenume }} {{ user.nume }}</h4>
            <p class="user-email">{{ user.email }}</p>
          </div>
          <div class="user-details" *ngIf="user.telefon || user.specialitate">
            <span *ngIf="user.telefon" class="detail-item">
              <i class="bi bi-telephone"></i> {{ user.telefon }}
            </span>
            <span *ngIf="user.specialitate" class="detail-item">
              <i class="bi bi-briefcase"></i> {{ user.specialitate }}
            </span>
          </div>
        </div>
        <div class="user-action">
          <i class="bi bi-chat-left-text"></i>
        </div>
      </div>
    </div>

    <!-- Rezultate căutare -->
    <div class="user-cards" *ngIf="searchTerm">
      <div 
        *ngFor="let user of filteredUsers" 
        class="user-card"
        [class.has-unread]="user.unreadMessagesCount > 0"
        (click)="selectUser(user)">
        <div class="user-avatar">
          <img [src]="getUserProfilePhoto(user)" 
               [alt]="user.prenume + ' ' + user.nume"
               (error)="onImageError($event)"
               class="avatar-img">
          <i class="bi bi-person-circle"></i>
          <span class="unread-badge" *ngIf="user.unreadMessagesCount > 0">{{ user.unreadMessagesCount }}</span>
        </div>
        <div class="user-info">
          <div class="user-name-email">
            <h4>{{ user.prenume }} {{ user.nume }}</h4>
            <p class="user-email">{{ user.email }}</p>
          </div>
          <div class="user-details" *ngIf="user.telefon || user.specialitate">
            <span *ngIf="user.telefon" class="detail-item">
              <i class="bi bi-telephone"></i> {{ user.telefon }}
            </span>
            <span *ngIf="user.specialitate" class="detail-item">
              <i class="bi bi-briefcase"></i> {{ user.specialitate }}
            </span>
          </div>
        </div>
        <div class="user-action">
          <i class="bi bi-chat-left-text"></i>
        </div>
      </div>
    </div>

    <!-- No Results -->
    <div class="no-results" *ngIf="filteredUsers.length === 0 && allUsers.length > 0">
      <i class="bi bi-search"></i>
      <h3>Niciun rezultat</h3>
      <p>Nu s-au găsit utilizatori pentru "{{ searchTerm }}"</p>
    </div>

    <!-- No Users -->
    <div class="no-users" *ngIf="allUsers.length === 0">
      <i class="bi bi-people"></i>
      <h3>Nu există utilizatori</h3>
      <p>Nu există alți utilizatori în sistem momentan</p>
    </div>
  </div>
</div>

<!-- Chat Window -->
<div class="chat-overlay" *ngIf="showChat" (click)="closeChat()">
  <div class="chat-window" (click)="$event.stopPropagation()">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="chat-user-info">
        <div class="chat-avatar">
          <img [src]="getUserProfilePhoto(selectedUser)" 
               [alt]="selectedUser?.prenume + ' ' + selectedUser?.nume"
               (error)="onImageError($event)"
               class="avatar-img">
          <i class="bi bi-person-circle"></i>
        </div>
        <div class="chat-user-details">
          <h4>{{ selectedUser?.prenume }} {{ selectedUser?.nume }}</h4>
          <p class="online-status"><i class="bi bi-circle-fill"></i> Online</p>
        </div>
      </div>
      <button class="btn-close-chat" (click)="closeChat()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Chat Messages -->
    <div class="chat-messages">
      <div class="welcome-message" *ngIf="messages.length === 0 && !isLoading">
        <i class="bi bi-chat-heart"></i>
        <p>Începe o conversație cu {{ selectedUser?.prenume }}</p>
      </div>

      <div class="loading-message" *ngIf="isLoading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Se încarcă...</span>
        </div>
        <p>Se încarcă conversația...</p>
      </div>

      <div *ngFor="let message of messages" 
           class="message" 
           [ngClass]="{'message-sent': getMessageSender(message) === 'me', 'message-received': getMessageSender(message) !== 'me'}">
        
        <!-- Mesaj normal de text -->
        <div class="message-bubble" *ngIf="!message.tip || message.tip === 'text'">
          <p class="message-text">{{ message.continut }}</p>
          <span class="message-time">{{ message.dataTrimitere | date:'HH:mm' }}</span>
        </div>

        <!-- Mesaj cu pacient partajat -->
        <div class="message-bubble patient-shared-message" *ngIf="message.tip === 'pacient_partajat'">
          <div class="patient-card">
            <div class="patient-card-header">
              <i class="bi bi-person-badge"></i>
              <span>Pacient partajat</span>
            </div>
            <div class="patient-card-body">
              <h5>{{ message.pacientNume }} {{ message.pacientPrenume }}</h5>
              
              <!-- Informații de bază -->
              <div class="patient-details">
                <span *ngIf="message.pacientCnp"><i class="bi bi-card-text"></i> CNP: {{ message.pacientCnp }}</span>
                <span *ngIf="message.pacientDataNasterii"><i class="bi bi-calendar"></i> Născut: {{ message.pacientDataNasterii | date:'dd/MM/yyyy' }}</span>
                <span *ngIf="message.pacientSex"><i class="bi bi-gender-ambiguous"></i> {{ message.pacientSex === 'MASCULIN' ? 'Masculin' : 'Feminin' }}</span>
                <span *ngIf="message.pacientNumarTelefon"><i class="bi bi-telephone"></i> {{ message.pacientNumarTelefon }}</span>
              </div>

              <!-- Istoric medical -->
              <div class="patient-medical-info" *ngIf="message.pacientIstoricMedical">
                <h6><i class="bi bi-clipboard-pulse"></i> Istoric Medical</h6>
                <p class="medical-text">{{ message.pacientIstoricMedical }}</p>
              </div>

              <!-- Detalii -->
              <div class="patient-medical-info" *ngIf="message.pacientDetalii">
                <h6><i class="bi bi-file-text"></i> Detalii</h6>
                <p class="medical-text">{{ message.pacientDetalii }}</p>
              </div>

              <!-- Imagini -->
              <div class="patient-images-section" *ngIf="message.pacientImagini && getPacientImagini(message).length > 0">
                <h6><i class="bi bi-images"></i> Imagini Medicale ({{ getPacientImagini(message).length }})</h6>
                <div class="images-list">
                  <div *ngFor="let imagine of getPacientImagini(message); let i = index" class="image-item">
                    <div class="image-item-header">
                      <span class="image-number">{{ i + 1 }}.</span>
                      <strong>{{ imagine.nume }}</strong>
                    </div>
                    <div class="image-item-details">
                      <span><i class="bi bi-file-medical"></i> {{ imagine.tip }}</span>
                      <span><i class="bi bi-calendar"></i> {{ imagine.dataIncarcare | date:'dd/MM/yyyy' }}</span>
                    </div>
                    <div class="image-analysis" *ngIf="hasAnalysis(imagine)">
                      <div class="analysis-result" [class.has-tumor]="imagine.areTumoare" [class.no-tumor]="!imagine.areTumoare">
                        <i class="bi" [ngClass]="imagine.areTumoare ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill'"></i>
                        <span>{{ imagine.areTumoare ? '⚠️ Tumoare detectată' : '✓ Fără tumoare' }}</span>
                        <span *ngIf="imagine.tipTumoare" class="tumor-type">({{ imagine.tipTumoare }})</span>
                      </div>
                      <div class="confidence-display" *ngIf="imagine.confidenta">
                        <small>Încredere: {{ imagine.confidenta }}%</small>
                        <div class="confidence-bar-mini">
                          <div class="confidence-fill" [style.width.%]="imagine.confidenta"></div>
                        </div>
                      </div>
                    </div>
                    <div class="image-status-pending" *ngIf="!hasAnalysis(imagine) && imagine.statusAnaliza === 'in_procesare'">
                      <i class="bi bi-hourglass-split"></i>
                      <small>Analiză în curs...</small>
                    </div>
                    <div class="image-status-pending" *ngIf="!hasAnalysis(imagine) && (!imagine.statusAnaliza || imagine.statusAnaliza === 'neanalizata')">
                      <i class="bi bi-question-circle"></i>
                      <small>Neanalizată</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Fallback dacă nu sunt imagini -->
              <div class="patient-images-info" *ngIf="!message.pacientImagini && message.pacientNumarImagini !== undefined">
                <i class="bi bi-images"></i>
                <span>{{ message.pacientNumarImagini }} {{ message.pacientNumarImagini === 1 ? 'imagine medicală' : 'imagini medicale' }} disponibile</span>
              </div>
            </div>
            <div class="patient-card-footer">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Informații pacient partajate (doar vizualizare)
              </small>
            </div>
          </div>
          <span class="message-time">{{ message.dataTrimitere | date:'HH:mm' }}</span>
        </div>
        
        <!-- Mesaj cu imagine partajată -->
        <div class="message-bubble image-shared-message" *ngIf="message.tip === 'imagine_partajata'">
          <div class="shared-image-card">
            <div class="shared-image-header">
              <i class="bi bi-image"></i>
              <span>Imagine medicală</span>
              <span *ngIf="isDicomMessage(message)" class="dicom-badge-header">
                <i class="bi bi-badge-3d"></i> DICOM
              </span>
            </div>
            <div class="shared-image-preview">
              <!-- Preview pentru DICOM - placeholder interactiv -->
              <div *ngIf="isDicomMessage(message)" 
                   class="dicom-shared-preview-card clickable-dicom"
                   (click)="openDicomImage(message.imagineId)"
                   title="Click pentru vizualizare completă">
                <div class="dicom-icon-container">
                  <i class="bi bi-file-earmark-medical"></i>
                </div>
                <div class="dicom-info-text">
                  <span class="dicom-file-label">Fișier Medical DICOM</span>
                  <span class="dicom-file-name">{{ message.imagineNume }}</span>
                  <small class="dicom-click-hint">
                    <i class="bi bi-eye"></i> Click pentru vizualizare interactivă
                  </small>
                </div>
              </div>
              <!-- Preview pentru imagini normale -->
              <img *ngIf="!isDicomMessage(message)" 
                   [src]="message.imagineUrl" 
                   [alt]="message.imagineNume" 
                   class="shared-image-img"
                   (click)="openImage(message.imagineId)"
                   title="Click pentru detalii" />
            </div>
            <div class="shared-image-info">
              <h6>{{ message.imagineNume }}</h6>
              <div class="image-meta">
                <span *ngIf="message.imagineTip"><i class="bi bi-file-medical"></i> {{ message.imagineTip }}</span>
                <span *ngIf="message.imagineDataIncarcare"><i class="bi bi-calendar"></i> {{ message.imagineDataIncarcare | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="image-action-hint" *ngIf="message.imagineId">
                <i class="bi bi-eye"></i>
                <small>Click pe imagine pentru vizualizare completă</small>
              </div>
            </div>
          </div>
          <span class="message-time">{{ message.dataTrimitere | date:'HH:mm' }}</span>
        </div>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <button 
          class="btn-attach-image" 
          (click)="openImageSelector()"
          title="Partajează o imagine medicală">
          <i class="bi bi-image"></i>
        </button>
        <textarea 
          [(ngModel)]="messageText" 
          (keypress)="onKeyPress($event)"
          class="chat-input" 
          placeholder="Scrie un mesaj..."
          rows="1"></textarea>
        <button 
          class="btn-send" 
          (click)="sendMessage()"
          [disabled]="!messageText.trim()">
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pentru selectare imagine -->
<div *ngIf="showImageSelectorModal" class="modal-overlay" (click)="closeImageSelector()">
  <div class="image-selector-modal" (click)="$event.stopPropagation()">
    <div class="modal-header-image">
      <h5><i class="bi bi-images"></i> Partajează o imagine medicală</h5>
      <button class="btn-close-modal" (click)="closeImageSelector()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <!-- Lista de pacienți -->
    <div class="modal-body-image" *ngIf="!selectedPacientForSharing">
      <div class="search-section-modal">
        <input 
          type="text" 
          [(ngModel)]="searchPacientTerm" 
          (input)="searchPacienti()"
          class="search-input-modal" 
          placeholder="Caută pacient după nume sau CNP..." />
      </div>
      
      <div class="pacienti-list">
        <div *ngFor="let pacient of filteredPacientiForSharing" 
             class="pacient-item"
             (click)="selectPacientForSharing(pacient)">
          <div class="pacient-avatar">
            <i class="bi bi-person-circle"></i>
          </div>
          <div class="pacient-info">
            <h6>{{ pacient.numePacient }} {{ pacient.prenumePacient }}</h6>
            <small *ngIf="pacient.cnp">CNP: {{ pacient.cnp }}</small>
            <small class="text-muted">
              <i class="bi bi-images"></i> {{ pacient.imagini.length || 0 }} imagini
            </small>
          </div>
          <i class="bi bi-chevron-right"></i>
        </div>
        
        <div *ngIf="filteredPacientiForSharing.length === 0" class="no-results-modal">
          <i class="bi bi-info-circle"></i>
          <p>Nu există pacienți cu imagini disponibile</p>
        </div>
      </div>
    </div>
    
    <!-- Lista de imagini -->
    <div class="modal-body-image" *ngIf="selectedPacientForSharing">
      <div class="back-button-section">
        <button class="btn-back-modal" (click)="backToPacientList()">
          <i class="bi bi-arrow-left"></i> Înapoi la pacienți
        </button>
      </div>
      
      <div class="selected-pacient-info">
        <h6>{{ selectedPacientForSharing.numePacient }} {{ selectedPacientForSharing.prenumePacient }}</h6>
        <small *ngIf="selectedPacientForSharing.cnp">CNP: {{ selectedPacientForSharing.cnp }}</small>
      </div>
      
      <div class="search-section-modal">
        <input 
          type="text" 
          [(ngModel)]="searchImagineTerm" 
          (input)="searchImagini()"
          class="search-input-modal" 
          placeholder="Caută imagine..." />
      </div>
      
      <div class="imagini-grid">
        <div *ngFor="let imagine of filteredImaginiForSharing" 
             class="imagine-item"
             (click)="shareImage(imagine)">
          <div class="imagine-preview">
            <!-- Preview pentru imagini DICOM -->
            <div *ngIf="imagine.isDicom" class="dicom-preview-modal">
              <i class="bi bi-file-earmark-medical"></i>
              <span>DICOM</span>
            </div>
            <!-- Preview pentru imagini normale -->
            <img *ngIf="!imagine.isDicom" [src]="imagine.imageUrl" [alt]="imagine.nume" />
          </div>
          <div class="imagine-info">
            <h6>{{ imagine.nume }}</h6>
            <small *ngIf="imagine.tip"><i class="bi bi-file-medical"></i> {{ imagine.tip }}</small>
            <small *ngIf="imagine.dataIncarcare"><i class="bi bi-calendar"></i> {{ imagine.dataIncarcare | date:'dd/MM/yyyy' }}</small>
            <small *ngIf="imagine.isDicom" class="dicom-badge"><i class="bi bi-badge-3d"></i> DICOM</small>
          </div>
        </div>
        
        <div *ngIf="filteredImaginiForSharing.length === 0" class="no-results-modal">
          <i class="bi bi-info-circle"></i>
          <p>Nu există imagini disponibile</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pentru vizualizare imagine partajată -->
<div *ngIf="showSharedImageViewer" class="shared-viewer-overlay" (click)="closeSharedImageViewer()">
  <div class="shared-viewer-modal" (click)="$event.stopPropagation()">
    <div class="shared-viewer-header">
      <div class="viewer-title">
        <i class="bi" [ngClass]="sharedImageIsDicom ? 'bi-file-earmark-medical' : 'bi-image'"></i>
        <h5>{{ sharedImageName }}</h5>
        <span *ngIf="sharedImageIsDicom" class="dicom-badge-viewer">
          <i class="bi bi-badge-3d"></i> DICOM
        </span>
      </div>
      <div class="viewer-actions">
        <button class="btn-viewer-action" (click)="downloadSharedImage()" title="Descarcă imaginea">
          <i class="bi bi-download"></i>
        </button>
        <button class="btn-viewer-close" (click)="closeSharedImageViewer()" title="Închide">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>
    
    <div class="shared-viewer-body">
      <!-- Preview pentru DICOM -->
      <div *ngIf="sharedImageIsDicom" class="dicom-viewer-content">
        <!-- Metadate DICOM -->
        <div class="dicom-metadata-box" *ngIf="sharedDicomMetadata">
          <h6><i class="bi bi-info-circle"></i> Informații DICOM</h6>
          <div class="metadata-grid">
            <div class="metadata-item">
              <span class="metadata-label">Pacient:</span>
              <span class="metadata-value">{{ sharedDicomMetadata.patientName }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Modalitate:</span>
              <span class="metadata-value">{{ sharedDicomMetadata.modality }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Data studiu:</span>
              <span class="metadata-value">{{ sharedDicomMetadata.studyDate }}</span>
            </div>
            <div class="metadata-item" *ngIf="sharedDicomMetadata.studyDescription">
              <span class="metadata-label">Descriere:</span>
              <span class="metadata-value">{{ sharedDicomMetadata.studyDescription }}</span>
            </div>
          </div>
        </div>
        
        <!-- Canvas DICOM -->
        <div class="dicom-canvas-container">
          <div #dicomCanvas class="dicom-canvas"></div>
        </div>
        
        <!-- Acțiuni -->
        <div class="dicom-actions">
          <button class="btn-download-large" (click)="downloadSharedImage()">
            <i class="bi bi-download"></i>
            Descarcă fișierul DICOM
          </button>
        </div>
      </div>
      
      <!-- Preview pentru imagini normale -->
      <div *ngIf="!sharedImageIsDicom" class="normal-image-viewer">
        <img [src]="sharedImageUrl" [alt]="sharedImageName" class="viewer-image" />
      </div>
    </div>
    
    <div class="shared-viewer-footer">
      <small class="text-muted">
        <i class="bi bi-info-circle"></i>
        Imagine partajată în mesagerie
      </small>
    </div>
  </div>
</div>
